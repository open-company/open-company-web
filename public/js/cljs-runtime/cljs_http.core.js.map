{"version":3,"sources":["cljs_http/core.cljs"],"mappings":"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","names":["cljs-http.core/pending-requests","cljs.core.atom","cljs-http.core/abort!","channel","temp__5735__auto__","req","fexpr__39370","cljs.core/deref","cljs.core.swap_BANG_","cljs.core/dissoc","cljs.core.async/close!","cljs-http.core/aborted?","xhr","cljs.core._EQ_","js/goog.net.ErrorCode.ABORT","cljs-http.core/apply-default-headers!","headers","formatted-h","cljs.core/zipmap","cljs.core.map","cljs-http.util/camelize","cljs.core/keys","cljs.core/vals","cljs.core.dorun","p__39371","vec__39373","cljs.core.nth","k","v","cljs-http.core/apply-response-type!","response-type","G__39376","js/Error","goog.net.XhrIo/ResponseType","p__39378","map__39379","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","cljs-http.core/build-xhr","with-credentials?","default-headers","request","timeout","or__4126__auto__","send-credentials","G__39382","js/goog.net.XhrIo","cljs-http.core/error-kw","p__39383","map__39384","cljs-http.core/xhr","request-method","body","cancel","progress","cljs.core.async.chan","request-url","cljs-http.util/build-url","method","cljs.core/name","cljs-http.util/build-headers","cljs.core/assoc","goog.net.EventType/COMPLETE","evt","target","response","cljs-http.util/parse-headers","G__39387","cljs.core.async.put_BANG_","listener","direction","cljs.core.merge","G__39388","goog.net.EventType/UPLOAD_PROGRESS","cljs.core.partial","goog.net.EventType/DOWNLOAD_PROGRESS","c__31487__auto__","cljs.core.async.impl.dispatch/run","f__31488__auto__","switch__31464__auto__","state_39409","state_val_39410","cljs.core.async.impl.ioc-helpers/take!","inst_39398","inst_39399","inst_39400","statearr-39412","statearr-39413","statearr-39414","inst_39402","statearr-39416","statearr-39417","inst_39405","cljs.core.async.impl.ioc-helpers/return-chan","statearr-39418","state-machine__31465__auto__","ret-value__31466__auto__","result__31467__auto__","cljs.core/keyword-identical?","ex__31468__auto__","e39419","statearr-39420","cljs.core/seq","statearr-39421","cljs.core/first","state__31489__auto__","statearr-39422","cljs.core.async.impl.ioc-helpers/USER-START-IDX","cljs.core.async.impl.ioc-helpers/run-state-machine-wrapped","cljs.core/not","p__39423","map__39424","cljs-http.core/jsonp","callback-name","keywordize-keys?","jsonp","js/goog.net.Jsonp","data","cljs.core.js__GT_clj","state_39430","state_val_39431","inst_39427","inst_39428","statearr-39432","statearr-39433","e39434","statearr-39435","statearr-39436","statearr-39437","p__39438","map__39439","cljs-http.core/request"],"sourcesContent":["(ns cljs-http.core\n  (:import [goog.net EventType ErrorCode XhrIo]\n           [goog.net Jsonp])\n  (:require-macros [cljs.core.async.macros :refer [go]])\n  (:require [cljs-http.util :as util]\n            [cljs.core.async :as async]\n            [clojure.string :as s]))\n\n(def pending-requests (atom {}))\n\n(defn abort!\n  \"Attempt to close the given channel and abort the pending HTTP request\n  with which it is associated.\"\n  [channel]\n  (when-let [req (@pending-requests channel)]\n    (swap! pending-requests dissoc channel)\n    (async/close! channel)\n    (if (.hasOwnProperty req \"abort\")\n      (.abort req)\n      (.cancel (:jsonp req) (:request req)))))\n\n(defn- aborted? [xhr]\n  (= (.getLastErrorCode xhr) goog.net.ErrorCode.ABORT))\n\n(defn apply-default-headers!\n  \"Takes an XhrIo object and applies the default-headers to it.\"\n  [xhr headers]\n  (let [formatted-h (zipmap (map util/camelize (keys headers)) (vals headers))]\n    (dorun\n      (map (fn [[k v]]\n             (.set (.-headers xhr) k v))\n           formatted-h))))\n\n(defn apply-response-type!\n  \"Takes an XhrIo object and sets response-type if not nil.\"\n  [xhr response-type]\n  (.setResponseType xhr\n   (case response-type\n     :array-buffer XhrIo.ResponseType.ARRAY_BUFFER\n     :blob XhrIo.ResponseType.BLOB\n     :document XhrIo.ResponseType.DOCUMENT\n     :text XhrIo.ResponseType.TEXT\n     :default XhrIo.ResponseType.DEFAULT\n     nil XhrIo.ResponseType.DEFAULT)))\n\n(defn build-xhr\n  \"Builds an XhrIo object from the request parameters.\"\n  [{:keys [with-credentials? default-headers response-type] :as request}]\n  (let [timeout (or (:timeout request) 0)\n        send-credentials (if (nil? with-credentials?)\n                           true\n                           with-credentials?)]\n    (doto (XhrIo.)\n          (apply-default-headers! default-headers)\n          (apply-response-type! response-type)\n          (.setTimeoutInterval timeout)\n          (.setWithCredentials send-credentials))))\n\n;; goog.net.ErrorCode constants to CLJS keywords\n(def error-kw\n  {0 :no-error\n   1 :access-denied\n   2 :file-not-found\n   3 :ff-silent-error\n   4 :custom-error\n   5 :exception\n   6 :http-error\n   7 :abort\n   8 :timeout\n   9 :offline})\n\n(defn xhr\n  \"Execute the HTTP request corresponding to the given Ring request\n  map and return a core.async channel.\"\n  [{:keys [request-method headers body with-credentials? cancel progress] :as request}]\n  (let [channel (async/chan)\n        request-url (util/build-url request)\n        method (name (or request-method :get))\n        headers (util/build-headers headers)\n        xhr (build-xhr request)]\n    (swap! pending-requests assoc channel xhr)\n    (.listen xhr EventType.COMPLETE\n             (fn [evt]\n               (let [target (.-target evt)\n                     response {:status (.getStatus target)\n                               :success (.isSuccess target)\n                               :body (.getResponse target)\n                               :headers (util/parse-headers (.getAllResponseHeaders target))\n                               :trace-redirects [request-url (.getLastUri target)]\n                               :error-code (error-kw (.getLastErrorCode target))\n                               :error-text (.getLastError target)}]\n                 (if-not (aborted? xhr)\n                   (async/put! channel response))\n                 (swap! pending-requests dissoc channel)\n                 (if cancel (async/close! cancel))\n                 (async/close! channel))))\n\n    (when progress\n      (let [listener (fn [direction evt]\n                       (async/put! progress (merge {:direction direction :loaded (.-loaded evt)}\n                                                   (if (.-lengthComputable evt) {:total (.-total evt)}))))]\n        (doto xhr\n          (.setProgressEventsEnabled true)\n          (.listen EventType.UPLOAD_PROGRESS (partial listener :upload))\n          (.listen EventType.DOWNLOAD_PROGRESS (partial listener :download)))))\n\n    (.send xhr request-url method body headers)\n    (if cancel\n      (go\n        (let [v (async/<! cancel)]\n          (if (not (.isComplete xhr))\n            (.abort xhr)))))\n    channel))\n\n(defn jsonp\n  \"Execute the JSONP request corresponding to the given Ring request\n  map and return a core.async channel.\"\n  [{:keys [timeout callback-name cancel keywordize-keys?]\n    :or {keywordize-keys? true}\n    :as request}]\n  (let [channel (async/chan)\n        jsonp (Jsonp. (util/build-url request) callback-name)]\n    (.setRequestTimeout jsonp timeout)\n    (let [req (.send jsonp nil\n                     (fn success-callback [data]\n                       (let [response {:status 200\n                                       :success true\n                                       :body (js->clj data :keywordize-keys keywordize-keys?)}]\n                         (async/put! channel response)\n                         (swap! pending-requests dissoc channel)\n                         (if cancel (async/close! cancel))\n                         (async/close! channel)))\n                     (fn error-callback []\n                         (swap! pending-requests dissoc channel)\n                         (if cancel (async/close! cancel))\n                         (async/close! channel)))]\n      (swap! pending-requests assoc channel {:jsonp jsonp :request req})\n      (if cancel\n        (go\n          (let [v (async/<! cancel)]\n            (.cancel jsonp req)))))\n    channel))\n\n(defn request\n  \"Execute the HTTP request corresponding to the given Ring request\n  map and return a core.async channel.\"\n  [{:keys [request-method] :as request}]\n  (if (= request-method :jsonp)\n    (jsonp request)\n    (xhr request)))\n"]}